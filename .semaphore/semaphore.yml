version: v1.0
name: Pack a relase
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: make
    task:
      jobs:
        - name: Make PDF
          commands:
            - checkout
            - sed -i -e "s/\$MONTHYEAR/$(date +'%b %Y')/g" chapters/01-introduction.md
            - sed -i -e "s/\$REVISION/$(git rev-parse --short HEAD)/g" chapters/01-introduction.md
            - make pdf
            - ./deps/cpdf cover/cover.pdf build/pdf/CICD_with_Docker_Kubernetes_Semaphore.pdf -o CICD_with_Docker_Kubernetes_Semaphore.pdf
            - artifact push workflow CICD_with_Docker_Kubernetes_Semaphore.pdf
        - name: Lint
          commands:
            - ls
        - name: Security
          commands:
            - ls
    dependencies: []
  - name: Unit
    dependencies:
      - make
    task:
      jobs:
        - name: 'Job #1'
          commands:
            - ls
        - name: 'Job #2'
          commands: []
  - name: Inter
    dependencies:
      - make
    task:
      jobs:
        - name: Integ
          commands:
            - ls
          parallelism: 6
  - name: Pack a relase
    dependencies:
      - Inter
      - Unit
    task:
      jobs:
        - name: 'Job #1'
          commands: []
promotions:
  - name: Deploy to Stg
    pipeline_file: pipeline_2.yml
    auto_promote:
      when: result = 'passed'
